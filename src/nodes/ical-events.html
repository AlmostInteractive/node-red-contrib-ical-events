<script type="text/javascript">

    $.getScript("resources/node-red-contrib-ical-events/prepareIcalEvents.js",
        () =>
            RED
                .nodes
                .registerType('ical-events', {
                    category: 'ical',
                    defaults: {
                        confignode: {
                            value: "",
                            type: "ical-config",
                            required: false
                        },
                        timeout: {
                            value: ""
                        },
                        timeoutUnits: {
                            value: ""
                        },
                        cron: {
                            value: ""
                        },
                        name: {
                            value: ""
                        },
                        offsettype: {},
                        offset: {
                            value: ""
                        },
                        offsetUnitstype: {},
                        offsetUnits: {
                            value: ""
                        },
                        eventtypes: {},
                        eventtypestype: {},
                        triggertype: {},
                        trigger: {},
                        timezone: {},
                        timezonetype: {},
                        filterProperty: {},
                        filterPropertytype: {},
                        filterOperator: {},
                        filterOperatortype: {},
                        filtertype: {},
                        filter2type: {},
                        filter2: {
                            required: false,
                            validate: function (v) {
                                let val = $("#node-input-filter2").val();
                                if (!val) return true;
                                try {
                                    if ($("#node-input-filterProperty").val().indexOf('event') >= 0) {
                                        let reg = new RegExp(/^(19|20)\d\d[-/.](0[1-9]|1[012])[-/.](0[1-9]|[12][0-9]|3[01])_([0-1][0-9]|2[0-3])[:]([0-5][0-9])[:]([0-5][0-9])$/)
                                        return reg.test(v)
                                    } else {
                                        new RegExp(v);
                                        return true;
                                    }
                                } catch (e) {
                                    return false;
                                }
                            },
                        },
                        filter: {
                            required: false,
                            validate: function (v) {
                                let val = $("#node-input-filter").val();
                                if (!val) return true;
                                try {
                                    if ($("#node-input-filterProperty").val().indexOf('event') >= 0) {
                                        let reg = new RegExp(/^(19|20)\d\d[-/.](0[1-9]|1[012])[-/.](0[1-9]|[12][0-9]|3[01])_([0-1][0-9]|2[0-3])[:]([0-5][0-9])[:]([0-5][0-9])$/)
                                        return reg.test(v)
                                    } else {
                                        new RegExp(v);
                                        return true;
                                    }
                                } catch (e) {
                                    return false;
                                }
                            },
                        },
                    },
                    inputs: 1,
                    outputs: 2,
                    outputLabels: ["Start Message", "End Message"],
                    color: "#DEBD5C",
                    label: function () {
                        if (this.name) {
                            return this.name;
                        } else if (this.confignode.name) {
                            return this.confignode.name;
                        }

                        return "event trigger";
                    },
                    icon: "font-awesome/fa-calendar",
                    paletteLabel: "trigger",
                    oneditprepare: function () {
                        prepareIcalEvents()
                        
                        $("#node-input-offsetUnits").typedInput({
                            typeField: "#node-input-offsetUnitstype",
                            default: "offsetUnits",
                            types: ["str", "msg", {
                                value: "offsetUnits",
                                options: [
                                    { value: "seconds", label: "Seconds" },
                                    { value: "minutes", label: "Minutes" },
                                    { value: "hours", label: "Hours" },
                                    { value: "days", label: "Days" }
                                ]
                            }]
                        });
                        $("#node-input-offset").typedInput({
                            typeField: "#node-input-offsettype",
                            types: ["num", "str", "msg"]
                        }).typedInput('width', '200px');

                        $('#node-input-offset').on('change', function (event, type, value) {
                            if (type === 'str') {
                                $('#offsetUnits').hide();
                            } else {
                                $('#offsetUnits').show();
                            }
                        });

                        if (!this.offsetUnits) {
                            $("#node-input-offsetUnits option").filter(function () {
                                return $(this).val() == 'minutes';
                            }).attr('selected', true);
                        }

                        
                    }
                }))
</script>

<script type="text/x-red" data-template-name="ical-events">
    <style>
        .event {
            display:flex;
        }
        .event .red-ui-typedInput-container {
            flex:1
        }
        .event span {
            flex:1
        }
        .event label {
            min-width: 110px;
            align-self: center;
        }  
        .padding-top {
            padding-top: 10px;
        }
    </style>   

    <div class="form-row event">        
        <label for="node-input-name"><i class="fa fa-tag"></i> <span>Name</span></label>
        <input type="text" id="node-input-name">
    </div>
    <hr/>
    <div class="form-row event">
        <label for="node-input-confignode"><i class="fa fa-globe"></i> <span>Config</span></label>
        <input type="text" id="node-input-confignode">
    </div>
    <div class="form-row event">
        <label for="node-input-eventtypes"  >
            <i class="fa fa-asterisk"></i>
            <span>Event types:</span></label>
            <input type="text" id="node-input-eventtypes" placeholder="events,todos">
            <input type="hidden" id="node-input-eventtypestype" placeholder="">
    </div>
    <div class="form-row event padding-top" id="timeout-details-for">
        <label for="node-input-timeout"><i class="fa fa-clock-o"></i> <span>Check every</span></label>
        <input type="text" id="node-input-timeout" style="width:50px !important">
        <select id="node-input-timeoutUnits" style="width:200px !important">          
          <option value="seconds">Seconds</option>
          <option value="minutes">Minutes</option>
          <option value="hours">Hours</option>
          <option value="days">Days</option>
        </select>
    </div>
    <div class="form-row event">
        <label for="node-input-trigger"><i class="fa fa-filter"></i> <span>Trigger</span></label>
        <input type="text" id="node-input-trigger" style="text-align:end; width:50px !important">
        <input type="hidden" id="node-input-triggertype" style="text-align:end; width:50px !important">
    </div>
    <div class="form-row event">
        <input type="hidden" id="node-input-filterPropertytype">
        <label for="node-input-filterProperty"><i class="fa fa-filter"></i> Filter property</label>
        <input type="text" id="node-input-filterProperty">          
    </div>
    <div class="form-row event">
        <input type="hidden" id="node-input-filterOperatortype">
        <label for="node-input-filterOperator"><i class="fa fa-filter"></i> Filter operator</label>
        <input type="text" id="node-input-filterOperator">  
      
    </div>
    <div class="form-tips" id="filter-tip" style="margin-bottom: 10px">     
        <i class="fa fa-exclamation"></i>
            <b>HINT:</b> filter format for dates is <b>YYYY-MM-DD_hh:mm:sss</b>
    </div>
    <div class="form-row event">
        <label for="node-input-filter" id="node-input-filter-label1"><i class="fa fa-filter"></i> Filter</label>
        <label for="node-input-filter" id="node-input-filter-label2"><i class="fa fa-filter"></i> after</label>
        <label for="node-input-filter" id="node-input-filter-label3"><i class="fa fa-filter"></i> before</label>
        <input type="text" id="node-input-filter">
        <input type="hidden" id="node-input-filtertype">
    </div>
    <div class="form-row event">
        <label for="node-input-filter2" id="node-input-filter2-label1"><i class="fa fa-filter"></i> Filter2</label>
        <label for="node-input-filter2" id="node-input-filter2-label2"><i class="fa fa-filter"></i> before</label>
        <input type="text" id="node-input-filter2" >
        <input type="hidden" id="node-input-filter2type">
    </div>
    <div class="form-row event">
        <label for="node-input-offset"><i class="fa fa-clock-o"></i> <span>Offset</span></label>    
        <input type="hidden" id="node-input-offsettype">
        <input type="hidden" id="node-input-offsetUnitstype">        
        <input type="text" id="node-input-offset">
        <span class="event" id="offsetUnits">
            <input type="text" id="node-input-offsetUnits">
        </span>   
    </div>
    <div class="form-row event">
        <label for="node-input-timezone"><i class="fa fa-filter"></i> Timezone for output</label>
        <input type="text" id="node-input-timezone" placeholder="default is UTC">
    </div>
    
    <div class="form-row event">
        <label for="node-input-cron"><i class="fa fa-clock-o"></i> <span>Cron</span></label>
        <input type="text" id="node-input-cron">
    </div>
    
</script>

<!-- Simple Help Text -->
<script type="text/x-red" data-help-name="ical-events">
    <p>A node for upcoming events</p>
    
    <p>The calendar is checked for new events on input or cronjob. For events in the future within the preview timespan, a separated cronjob is generated. It's fired on the start datetime of the ical event. So, on input or check-cronjob, no output is generated. Only when an event starts.</p>
    <img src="https://github.com/naimo84/node-red-contrib-ical-events/raw/master/examples/example.png"/>
    <h3>Configuration</h3>
     
    <br/> • "Name": Displayname
    <br/> • "Offset": positive or negative value, when output is triggered before/after the event-startdate
    <span><br/> • <b>"Trigger"</b>: possible values: 
        <br/>&emsp;     Always (Filter expression is ignored)
        <br/> &emsp;      Match (only events that match the Filter expression are processed)
        <br/> &emsp;      No Match (only events that don't match the Filter expression are processed)
    </span>
    <span><br/> • <b>"Filter property"</b>: possible values:
        <br/>&emsp;     summary
        <br/>&emsp;     description
        <br/>&emsp;     attendee
        <br/>&emsp;     category
        <br/>&emsp;     start date
        <br/>&emsp;     end date   
    </span>
    <br/>&emsp; if filterProperty is set to "start date" or "end date", additonally a filter operator is shown:
    <br/>&emsp;   filter format for dates is <b>YYYY-MM-DD_hh:mm:sss</b>
    <br/>&emsp; <b>"Filter operator"</b>: possible values:
    <br/>&emsp;     between
    <br/>&emsp;     bofore
    <br/>&emsp;     after
    <br/> • <b>"Filter"</b>: filter property of the events from above is filtered against this regular expression
    <br/><br/> • <b>"Cron"</b>: Cron expression, how often the calendar is checked for new events. Default is every hour ('0 0 * * * *') 
    <br/><br/>    •  <b>"timezone for output"</b>: default is UTC, so eventStart and eventEnd will be a UTC string  
    <pre>
    <br/>eventStart: "2021-07-05T03:50:00.000Z"
    <br/>eventEnd: "2021-07-05T04:30:00.000Z"
    <br/></pre>
    e.g. set timezone to <b>Europe/Berlin</b>
    <br/><pre>
    <br/>eventStart: "2021-07-05T05:50:00.000+02:00"
    <br/>eventEnd: "2021-07-05T06:30:00.000+02:00"    
    <br/></pre>
    <hr/> 
    <h3>Output</h3>
    <p>The msg.payload contains the following values of the calendar entry</p>
    <br/> • summary
    <br/> • id
    <br/> • location
    <br/> • eventStart
    <br/> • eventEnd
    <br/> • description
    <br/> • allDay
    <br/> • attendee
    <br/> • isRecurring
    <br/> • calendarName
    <br/> • organizer
    <br/> • categories
    <br/> • duration
</script>