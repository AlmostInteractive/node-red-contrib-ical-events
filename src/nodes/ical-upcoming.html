<script type="text/javascript">
    $.getScript("resources/node-red-contrib-ical-events/prepareIcalEvents.js",
        () => RED.nodes.registerType('ical-upcoming', {
            category: 'ical',
            defaults: Object.assign(icalDefaults,
                {
                    checkall: {
                        value: false,
                    },
                    endpreview: {
                        value: '',
                    },
                    endpreviewUnits: {
                        value: '',
                    },
                    previewtype: {},
                    preview: {
                        value: '',
                    },
                    previewUnitstype: {},
                    previewUnits: {
                        value: '',
                    },
                    pastviewtype: {},
                    pastview: {
                        value: '',
                    },
                    pastviewUnits: {
                        value: '',
                    },
                    pastviewUnitstype: {},
                }),
            inputs: 1,
            outputs: 1,
            color: '#DEBD5C',
            label: function () {
                if (this.name) {
                    return this.name;
                } else if (this.confignode.name) {
                    return this.confignode.name;
                }

                return 'upcoming events';
            },
            icon: "font-awesome/fa-calendar",
            paletteLabel: 'upcoming',
            oneditprepare: function () {
                prepareIcalEvents();
                let node = this;
                $('#node-input-combineResponse').parent().hide();
                $('#node-input-offset').parent().hide();
                $('#node-input-filter2').parent().hide();

                if (!node.previewUnits) {
                    $('#node-input-previewUnits option')
                        .filter(function () {
                            if (node.endpreviewUnits) {
                                return $(this).val() == node.endpreviewUnits;
                            } else {
                                return $(this).val() == 'days';
                            }
                        })
                        .attr('selected', true);
                }

                if (!node.preview && node.endpreview) {
                    $('#node-input-preview').val(node.endpreview);
                }

                if (!node.pastviewUnits) {
                    $('#node-input-pastviewUnits option')
                        .filter(function () {
                            return $(this).val() == 'days';
                        })
                        .attr('selected', true);
                }

                $('#node-input-preview').on('change', function (event, type, value) {
                    if (type === 'str') {
                        $('#previewUnits').hide();
                    } else {
                        $('#previewUnits').show();
                    }
                });

                $('#node-input-pastview').on('change', function (event, type, value) {
                    if (type === 'str') {
                        $('#pastviewUnits').hide();
                    } else {
                        $('#pastviewUnits').show();
                    }
                });

                $("#node-input-pastview").typedInput({
                    typeField: "#node-input-pastviewtype",
                    types: ["num", "str", "msg"]
                }).typedInput('width', '200px');

                $("#node-input-pastviewUnits").typedInput({
                    typeField: "#node-input-pastviewUnitstype",
                    default: "pastviewUnits",
                    types: ["str", "msg", {
                        value: "pastviewUnits",
                        options: [
                            { value: "seconds", label: "Seconds" },
                            { value: "minutes", label: "Minutes" },
                            { value: "hours", label: "Hours" },
                            { value: "days", label: "Days" }
                        ]
                    }]
                });

                $("#node-input-preview").typedInput({
                    typeField: "#node-input-previewtype",
                    types: ["num", "str", "msg"]
                }).typedInput('width', '200px');


                $("#node-input-previewUnits").typedInput({
                    typeField: "#node-input-previewUnitstype",
                    default: "previewUnits",
                    types: ["str", "msg", {
                        value: "previewUnits",
                        options: [
                            { value: "seconds", label: "Seconds" },
                            { value: "minutes", label: "Minutes" },
                            { value: "hours", label: "Hours" },
                            { value: "days", label: "Days" }
                        ]
                    }]
                });

            }
        }))
</script>

<script type="text/javascript" id="icalUpcoming-template" data-template-name="ical-upcoming">
    $(function () {
        $("#icalUpcoming-template").load("resources/node-red-contrib-ical-events/icalEvents.html");
    });
</script>

<script type="text/x-red" data-help-name="ical-upcoming">
    <h1>A node for upcoming events</h1>

    <p>As of the events node, its checked on input or cronjob.</p>
        <img src="https://github.com/naimo84/node-red-contrib-ical-events/raw/master/examples/example.png"/>
    <h3>Configuration</h3>
    <br/> • <b>"Name"</b>: Displayname of the node
    <br/> • <b>"Fetch all configs concurrent"</b>: All Configs will be fetched concurrent and only one message will be send
    <br/> • <b>"Check every"</b>: Value in seconds, minutes, hours or days, how often the calendar is checked for new upcoming events. <i>0 or empty value to disable.</i>       
    <span><br/> • <b>"Trigger"</b>: possible values:
        <br/>&emsp;     Always (Filter expression is ignored)
        <br/>&emsp;      Match (only events that match the Filter expression are processed)
        <br/>&emsp;      No Match (only events that don't match the Filter expression are processed)
    </span>
    <span><br/> • <b>"Filter property"</b>: possible values:
        <br/>&emsp;     summary
        <br/>&emsp;     description
        <br/>&emsp;     attendee
        <br/>&emsp;     category
        <br/>&emsp;     start date
        <br/>&emsp;     end date   
    </span>
    <br/>&emsp; if filterProperty is set to "start date" or "end date", additonally a filter operator is shown:
    <br/>&emsp;   filter format for dates is <b>YYYY-MM-DD_hh:mm:sss</b>

<span><br/> • <b>"Filter operator"</b>: possible values:
    <br/>&emsp;     between
    <br/>&emsp;     before
    <br/>&emsp;     after
</span>
    <br/> • <b>"Filter"</b>: filter property of the events from above is filtered against this regular expression
    <br/> • <b>"Preview"</b>: Only Events within now and this <b>future</b> value are checked.
    <br/> • <b>"Past view"</b>: Only Events within now and this <b>past</b> value are checked.   
    <br/><br/> • <b>"Cron"</b>: Similar to "Check every", but much more configurable. It's a cron expression, how often the calendar is checked for new upcoming events.
    <br/>   If Cron is defined, it wins against "Check every". <i>Empty value to disable.</i>
    <br/><br/>   •  <b>"timezone for output"</b>: default is UTC, so eventStart and eventEnd will be a UTC string  
    <pre>
    <br/>eventStart: "2021-07-05T03:50:00.000Z"
    <br/>eventEnd: "2021-07-05T04:30:00.000Z"
    <br/></pre>
    e.g. set timezone to <b>Europe/Berlin</b>
    <br/><pre>
    <br/>eventStart: "2021-07-05T05:50:00.000+02:00"
    <br/>eventEnd: "2021-07-05T06:30:00.000+02:00"    
    <br/></pre>
    <hr/> 
    <h3>Output</h3>
    <p>The <b>msg.payload</b> contains an array of the following values for each calendar entry
    <br/> • summary
    <br/> • id
    <br/> • location
    <br/> • eventStart
    <br/> • eventEnd
    <br/> • description
    <br/> • allDay
    <br/> • attendee
    <br/> • isRecurring
    <br/> • calendarName
    <br/> • organizer
    <br/> • categories
    <br/> • duration
    </p>
     <br/>
        <p><b>additional msg. values:</b>
        <br/> • today: counter for today's events
        <br/> • tomorrow: counter for tomorrow's events
        <br/> • total: total counter of all events
        <br/> • htmlTable: br separated list
        </p>
        <p>example output:</p>
        <pre>{
            "summary": "meeting",
            "id": "15ko5i37jhc634567dihn6g7h@google.com",
            "location": "office",
            "eventStart": "2019-08-13T12:45:00.000Z",
            "eventEnd": "2019-08-13T13:45:00.000Z"
        }</pre>
</script>