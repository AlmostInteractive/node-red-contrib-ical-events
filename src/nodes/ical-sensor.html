<script type="text/javascript">
    $.getScript("resources/node-red-contrib-ical-events/prepareIcalEvents.js",
        () => RED.nodes.registerType('ical-sensor', {
            category: 'ical',
            defaults: Object.assign(icalDefaults,
            {
                timeout: {
                    value: ""
                },
                timeoutUnits: {
                    value: ""
                },
                combineResponse: {}
            }),
            inputs: 1,
            outputs: 2,
            outputLabels: ["output on every tick", "output only on changes"],
            color: "#DEBD5C",
            label: function () {
                if (this.name) {
                    return this.name;
                } else if (this.confignode.name) {
                    return this.confignode.name;
                }

                return "event sensor";
            },
            icon: "font-awesome/fa-calendar",
            paletteLabel: "sensor",
            oneditprepare: function () {
                prepareIcalEvents();
                $('#node-input-offset').parent().hide();
                $('#node-input-pastview').parent().hide();
                $('#node-input-preview').parent().hide();
                $('#node-input-checkall').parent().hide();

                $('#node-input-combineResponse').change(() => {
                    var value = $('#node-input-combineResponse').prop('checked');
                    if (value) {
                        $('#combine-response-hint').show();
                    } else {
                        $('#combine-response-hint').hide();

                    }
                });
            }
        })
    )
</script>

<script type="text/javascript" id="icalSensor-template" data-template-name="ical-sensor">
    $(function () {
        $("#icalSensor-template").load("resources/node-red-contrib-ical-events/icalEvents.html");
    });  
</script>

<script type="text/x-red" data-help-name="ical-sensor">
    <p>A sensor node for events</p>
    
    <p>The calendar is checked for running events on input or configurable timeout.</p>

    <h3>Configuration</h3>
    <br/> • <b>"Check every"</b>: how often the calendar is checked for new events
    <span><br/> • <b>"Trigger"</b>: possible values: 
        <br/>&emsp;     Always (Filter expression is ignored)
        <br/> &emsp;      Match (only events that match the Filter expression are processed)
        <br/> &emsp;      No Match (only events that don't match the Filter expression are processed)
    </span>
    <span><br/> • <b>"Filter property"</b>: possible values:
        <br/>&emsp;     summary
        <br/>&emsp;     description
        <br/>&emsp;     attendee
        <br/>&emsp;     category
        <br/>&emsp;     start date
        <br/>&emsp;     end date   
    </span>
    <br/>&emsp; if filterProperty is set to "start date" or "end date", additonally a filter operator is shown:
    <br/>&emsp;   filter format for dates is <b>YYYY-MM-DD_hh:mm:sss</b>
    <br/>&emsp; <b>"Filter operator"</b>: possible values:
    <br/>&emsp;     between
    <br/>&emsp;     bofore
    <br/>&emsp;     after
    <br/> • <b>"Filter"</b>: filter property of the events from above is filtered against this regular expression
    <br/> • <b>"Name"</b>: Displayname
    <br/><br/>    •  <b>"timezone for output"</b>: default is UTC, so eventStart and eventEnd will be a UTC string  
    <pre>
    <br/>eventStart: "2021-07-05T03:50:00.000Z"
    <br/>eventEnd: "2021-07-05T04:30:00.000Z"
    <br/></pre>
    e.g. set timezone to <b>Europe/Berlin</b>
    <br/><pre>
    <br/>eventStart: "2021-07-05T05:50:00.000+02:00"
    <br/>eventEnd: "2021-07-05T06:30:00.000+02:00"    
    <br/></pre>
    <hr/> 
    <h3>Output</h3>
    <p>If an event is running at time of checking, <b>msg.on</b> is true, otherwise false.</p>

    <p>is msg.on=ture, the message additionaly contains the following values of the calendar entry</p>
    <br/> • summary
    <br/> • id
    <br/> • location
    <br/> • eventStart
    <br/> • eventEnd
    <br/> • description
    <br/> • allDay
    <br/> • attendee
    <br/> • isRecurring
    <br/> • calendarName
    <br/> • organizer
    <br/> • categories
    <br/> • duration
</script>