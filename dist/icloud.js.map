{"version":3,"sources":["../src/icloud.ts"],"names":[],"mappings":";;AAAA,IAAM,MAAM,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC;AACjC,IAAM,WAAW,GAAG,OAAO,CAAC,cAAc,CAAC,EACvC,MAAM,GAAG,WAAW,CAAC,YAAY,CAAC,MAAM,CAAC,EACzC,KAAK,GAAG,OAAO,CAAC,OAAO,CAAC,EACxB,YAAY,GAAG,OAAO,CAAC,eAAe,CAAC,EACvC,SAAS,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC;AAElC,SAAS,OAAO,CAAC,OAAO,EAAE,KAAK,EAAE,GAAG,EAAE,GAAG;IACrC,IAAM,GAAG,GAAG,IAAI,YAAY,CAAC,EAAE,GAAG,KAAA,EAAE,aAAa,EAAE,IAAI,EAAE,CAAC,CAAC;IAC3D,IAAM,MAAM,GAAG,GAAG,CAAC,OAAO,CAAC,KAAK,CAAC,MAAM,EAAE,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,CAAC;IAEzD,aAAa,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,UAAA,KAAK;QAC/B,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC;IAC/B,CAAC,CAAC,CAAC;AACP,CAAC;AAED,SAAS,aAAa,CAAC,MAAM;IACzB,IAAI,UAAU,GAAG,EAAE,CAAC;IACpB,IAAI,MAAM,EAAE;QACR,IAAI,MAAM,CAAC,MAAM,EAAE;YACf,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,UAAA,KAAK;gBACvB,IAAI,EAAE,GAAG,aAAa,CAAC,KAAK,CAAC,CAAC;gBAC9B,UAAU,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;YACxB,CAAC,CAAC,CAAC;SACN;QACD,IAAI,MAAM,CAAC,WAAW,EAAE;YACpB,IAAM,iBAAiB,GAAG,MAAM,CAAC,WAAW,CAAC,GAAG,CAAC,UAAA,CAAC,IAAI,OAAA,aAAa,CAAC,CAAC,CAAC,EAAhB,CAAgB,CAAC,CAAC;YACxE,IAAI,iBAAiB,CAAC,MAAM,GAAG,CAAC,EAAE;gBAC9B,UAAU,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAC,CAAA;aACxC;SACJ;KACJ;IAED,OAAO,UAAU,CAAC;AACtB,CAAC;AAED,SAAS,aAAa,CAAC,CAAC;IACpB,IAAI,CAAC,EAAE;QACH,IAAI,SAAS,GAAG,CAAC,CAAC,SAAS,CAAC,QAAQ,EAAE,CAAA;QACtC,IAAI,OAAO,GAAG,CAAC,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAA;QAElC,IAAI,CAAC,CAAC,IAAI,EAAE;YACR,CAAC,GAAG,CAAC,CAAC,IAAI,CAAA;SACb;QACD,IAAI,CAAC,CAAC,QAAQ,CAAC,eAAe,EAAE;YAC5B,OAAO,CAAC,CAAC,QAAQ,CAAC,eAAe,CAAA;SACpC;QAED,OAAO;YACH,KAAK,EAAE,SAAS;YAChB,GAAG,EAAE,OAAO;YACZ,OAAO,EAAE,CAAC,CAAC,OAAO,IAAI,EAAE;YACxB,WAAW,EAAE,CAAC,CAAC,WAAW,IAAI,EAAE;YAChC,SAAS,EAAE,CAAC,CAAC,SAAS;YACtB,QAAQ,EAAE,CAAC,CAAC,QAAQ,CAAC,YAAY,EAAE;YACnC,eAAe,EAAE,CAAC,CAAC,QAAQ,CAAC,SAAS,EAAE;YACvC,QAAQ,EAAE,CAAC,CAAC,QAAQ,IAAI,EAAE;YAC1B,SAAS,EAAE,CAAC,CAAC,SAAS,IAAI,EAAE;YAC5B,GAAG,EAAE,CAAC,CAAC,GAAG,IAAI,EAAE;YAChB,WAAW,EAAE,KAAK;YAClB,QAAQ,EAAE,MAAM;YAChB,IAAI,EAAE,QAAQ;YACd,MAAM,EAAE,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,SAAS,EAAE,GAAG,KAAK,CAAC,KAAK,CAAC,CAAC;SACnD,CAAA;KACJ;AACL,CAAC;AAED,SAAS,mBAAmB,CAAC,MAAM,EAAE,KAAK,EAAE,GAAG,EAAE,EAAE;IAC/C,IAAM,aAAa,GAAG,mBAAmB,EACrC,GAAG,GAAG,MAAM,CAAC,GAAG,EAChB,IAAI,GAAG,MAAM,CAAC,QAAQ,EACtB,IAAI,GAAG,MAAM,CAAC,QAAQ,EACtB,QAAQ,GAAG,wCAAwC,CAAC,IAAI,CAAC,GAAG,CAAC,EAC7D,QAAQ,GAAG,QAAQ,CAAC,CAAC,CAAC,EACtB,IAAI,GAAG,QAAQ,CAAC,CAAC,CAAC,EAClB,IAAI,GAAG,QAAQ,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,KAAK,OAAO,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,EACvD,IAAI,GAAG,QAAQ,CAAC,CAAC,CAAC,CAAC;IAEvB,IAAI,GAAG,GAAG,2CAA2C;QACjD,6EAA6E;QAC7E,cAAc;QACd,0BAA0B;QAC1B,eAAe;QACf,gBAAgB;QAChB,wCAAwC;QACxC,uCAAuC;QACvC,+BAA+B,GAAG,KAAK,CAAC,MAAM,CAAC,aAAa,CAAC,GAAG,SAAS,GAAG,GAAG,CAAC,MAAM,CAAC,aAAa,CAAC,GAAG,QAAQ;QAChH,0BAA0B;QAC1B,wBAAwB;QACxB,iBAAiB;QACjB,qBAAqB,CAAC;IAE1B,IAAI,OAAO,GAAG;QACV,kBAAkB,EAAE,KAAK;QACzB,QAAQ,EAAE,IAAI;QACd,IAAI,EAAE,IAAI;QACV,IAAI,EAAE,IAAI;QACV,MAAM,EAAE,QAAQ;QAChB,OAAO,EAAE;YACL,cAAc,EAAE,iBAAiB;YACjC,gBAAgB,EAAE,GAAG,CAAC,MAAM;YAC5B,YAAY,EAAE,cAAc;YAC5B,YAAY,EAAE,OAAO;YACrB,OAAO,EAAE,GAAG;SACf;KACJ,CAAC;IAEF,IAAI,IAAI,IAAI,IAAI,EAAE;QACd,IAAI,QAAQ,GAAG,MAAM,CAAC,IAAI,CAAC,IAAI,GAAG,GAAG,GAAG,IAAI,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;QACjE,OAAO,CAAC,OAAO,CAAC,eAAe,CAAC,GAAG,QAAQ,GAAG,QAAQ,CAAC;KAC1D;IAED,IAAI,GAAG,GAAG,KAAK,CAAC,OAAO,CAAC,OAAO,EAAE,UAAU,GAAG;QAC1C,IAAI,CAAC,GAAG,EAAE,CAAC;QACX,GAAG,CAAC,EAAE,CAAC,MAAM,EAAE,UAAU,KAAK;YAC1B,CAAC,IAAI,KAAK,CAAC;QACf,CAAC,CAAC,CAAC;QAEH,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE;YAEZ,IAAI;gBACA,IAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,MAAM,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;gBAE7E,EAAE,CAAC,IAAI,CAAC,CAAC;aACZ;YAAC,OAAO,CAAC,EAAE;gBACR,OAAO,CAAC,KAAK,CAAC,wBAAwB,EAAE,CAAC,CAAC,CAAA;aAC7C;QACL,CAAC,CAAC,CAAC;IACP,CAAC,CAAC,CAAC;IAEH,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;IAEb,GAAG,CAAC,EAAE,CAAC,OAAO,EAAE,UAAU,CAAC;QACvB,OAAO,CAAC,KAAK,CAAC,wBAAwB,GAAG,CAAC,CAAC,OAAO,CAAC,CAAC;IACxD,CAAC,CAAC,CAAC;AACP,CAAC;AAED,SAAgB,gBAAgB,CAAC,UAAU,EAAE,MAAM,EAAE,EAAE;IAGnD,IAAI,KAAK,GAAG,UAAU,CAAC,KAAK,EAAE,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,QAAQ,EAAE,MAAM,CAAC,aAAa,CAAC,CAAC;IAC9F,IAAI,GAAG,GAAG,UAAU,CAAC,KAAK,EAAE,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,UAAU,EAAE,MAAM,CAAC,eAAe,CAAC,CAAC;IAEzF,IAAI,MAAM,CAAC,aAAa,KAAK,MAAM,EAAE;QACjC,KAAK,GAAG,UAAU,CAAC,KAAK,EAAE,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,QAAQ,GAAG,CAAC,EAAE,MAAM,CAAC,CAAC;KACnF;IACD,IAAI,MAAM,CAAC,eAAe,KAAK,MAAM,EAAE;QACnC,GAAG,GAAG,UAAU,CAAC,KAAK,EAAE,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,GAAG,CAAC,MAAM,CAAC,UAAU,GAAG,CAAC,EAAE,MAAM,CAAC,CAAC;KAC5E;IAED,mBAAmB,CAAC,MAAM,EAAE,KAAK,EAAE,GAAG,EAAE,CAAC,UAAA,IAAI;QACzC,IAAI,OAAO,GAAG,EAAE,CAAC;QACjB,IAAI,IAAI,IAAI,IAAI,CAAC,WAAW,IAAI,IAAI,CAAC,WAAW,CAAC,QAAQ,EAAE;YACvD,IAAI,GAAG,CAAC;YACR,IAAI,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,QAAQ,EAAE;gBACpC,OAAO,CAAC,OAAO,EAAE,KAAK,EAAE,GAAG,EAAE,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC,MAAM,CAAC,CAAC;aACjG;iBAAM;gBACH,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC,OAAO,CAAC,UAAA,QAAQ,IAAI,OAAA,OAAO,CAAC,OAAO,EAAE,KAAK,EAAE,GAAG,EAAE,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC,MAAM,CAAC,EAA5E,CAA4E,CAAC,CAAC;aAC/H;SACJ;QACD,EAAE,CAAC,OAAO,EAAE,KAAK,EAAE,GAAG,CAAC,CAAC;IAC5B,CAAC,CAAC,CAAC,CAAC;AACR,CAAC;AAzBD,4CAyBC","file":"icloud.js","sourcesContent":["const Moment = require('moment');\r\nconst MomentRange = require('moment-range'),\r\n    moment = MomentRange.extendMoment(Moment),\r\n    https = require('https'),\r\n    icalExpander = require('ical-expander'),\r\n    xmlParser = require('xml-js');\r\n\r\nfunction process(reslist, start, end, ics) {\r\n    const cal = new icalExpander({ ics, maxIterations: 1000 });\r\n    const events = cal.between(start.toDate(), end.toDate());\r\n\r\n    convertEvents(events).forEach(event => {\r\n        reslist[event.uid] = event;\r\n    });\r\n}\r\n\r\nfunction convertEvents(events) {\r\n    let retEntries = [];\r\n    if (events) {\r\n        if (events.events) {\r\n            events.events.forEach(event => {\r\n                let ev = _convertEvent(event);\r\n                retEntries.push(ev);\r\n            });\r\n        }\r\n        if (events.occurrences) {\r\n            const mappedOccurrences = events.occurrences.map(o => _convertEvent(o));\r\n            if (mappedOccurrences.length > 0) {\r\n                retEntries.push(mappedOccurrences[0])\r\n            }\r\n        }\r\n    }\r\n\r\n    return retEntries;\r\n}\r\n\r\nfunction _convertEvent(e) {\r\n    if (e) {\r\n        let startDate = e.startDate.toJSDate()\r\n        let endDate = e.endDate.toJSDate()\r\n\r\n        if (e.item) {\r\n            e = e.item\r\n        }\r\n        if (e.duration.wrappedJSObject) {\r\n            delete e.duration.wrappedJSObject\r\n        }\r\n\r\n        return {\r\n            start: startDate,\r\n            end: endDate,\r\n            summary: e.summary || '',\r\n            description: e.description || '',\r\n            attendees: e.attendees,\r\n            duration: e.duration.toICALString(),\r\n            durationSeconds: e.duration.toSeconds(),\r\n            location: e.location || '',\r\n            organizer: e.organizer || '',\r\n            uid: e.uid || '',\r\n            isRecurring: false,\r\n            datetype: 'date',\r\n            type: 'VEVENT',\r\n            allDay: ((e.duration.toSeconds() % 86400) === 0)\r\n        }\r\n    }\r\n}\r\n\r\nfunction requestIcloudSecure(config, start, end, cb): any {\r\n    const DavTimeFormat = 'YYYYMMDDTHHmms\\\\Z',\r\n        url = config.url,\r\n        user = config.username,\r\n        pass = config.password,\r\n        urlparts = /(https?)\\:\\/\\/(.*?):?(\\d*)?(\\/.*\\/?)/gi.exec(url),\r\n        protocol = urlparts[1],\r\n        host = urlparts[2],\r\n        port = urlparts[3] || (protocol === \"https\" ? 443 : 80),\r\n        path = urlparts[4];\r\n\r\n    var xml = '<?xml version=\"1.0\" encoding=\"utf-8\" ?>\\n' +\r\n        '<C:calendar-query xmlns:D=\"DAV:\" xmlns:C=\"urn:ietf:params:xml:ns:caldav\">\\n' +\r\n        '  <D:prop>\\n' +\r\n        '    <C:calendar-data/>\\n' +\r\n        '  </D:prop>\\n' +\r\n        '  <C:filter>\\n' +\r\n        '    <C:comp-filter name=\"VCALENDAR\">\\n' +\r\n        '      <C:comp-filter name=\"VEVENT\">\\n' +\r\n        '        <C:time-range start=\"' + start.format(DavTimeFormat) + '\" end=\"' + end.format(DavTimeFormat) + '\" />\\n' +\r\n        '      </C:comp-filter>\\n' +\r\n        '    </C:comp-filter>\\n' +\r\n        '  </C:filter>\\n' +\r\n        '</C:calendar-query>';\r\n\r\n    var options = {\r\n        rejectUnauthorized: false,\r\n        hostname: host,\r\n        port: port,\r\n        path: path,\r\n        method: 'REPORT',\r\n        headers: {\r\n            \"Content-type\": \"application/xml\",\r\n            \"Content-Length\": xml.length,\r\n            \"User-Agent\": \"calDavClient\",\r\n            \"Connection\": \"close\",\r\n            \"Depth\": \"1\"\r\n        }\r\n    };\r\n\r\n    if (user && pass) {\r\n        var userpass = Buffer.from(user + \":\" + pass).toString('base64');\r\n        options.headers[\"Authorization\"] = \"Basic \" + userpass;\r\n    }\r\n\r\n    var req = https.request(options, function (res) {\r\n        var s = \"\";\r\n        res.on('data', function (chunk) {\r\n            s += chunk;\r\n        });\r\n\r\n        req.on('close', function () {\r\n\r\n            try {\r\n                const json = JSON.parse(xmlParser.xml2json(s, { compact: true, spaces: 0 }));\r\n\r\n                cb(json);\r\n            } catch (e) {\r\n                console.error(\"Error parsing response\", e)\r\n            }\r\n        });\r\n    });\r\n\r\n    req.end(xml);\r\n\r\n    req.on('error', function (e) {\r\n        console.error('problem with request: ' + e.message);\r\n    });\r\n}\r\n\r\nexport function loadEventsForDay(whenMoment, config, cb) {\r\n\r\n\r\n    let start = whenMoment.clone().startOf('day').subtract(config.pastview, config.pastviewUnits);\r\n    let end = whenMoment.clone().endOf('day').add(config.endpreview, config.endpreviewUnits);\r\n\r\n    if (config.pastviewUnits === 'days') {\r\n        start = whenMoment.clone().startOf('day').subtract(config.pastview + 1, 'days');\r\n    }\r\n    if (config.endpreviewUnits === 'days') {\r\n        end = whenMoment.clone().endOf('day').add(config.endpreview + 1, 'days');\r\n    }\r\n\r\n    requestIcloudSecure(config, start, end, (json => {\r\n        var reslist = {};\r\n        if (json && json.multistatus && json.multistatus.response) {\r\n            var ics;\r\n            if (json.multistatus.response.propstat) {\r\n                process(reslist, start, end, json.multistatus.response.propstat.prop['calendar-data']._cdata);\r\n            } else {\r\n                json.multistatus.response.forEach(response => process(reslist, start, end, response.propstat.prop['calendar-data']._cdata));\r\n            }\r\n        }\r\n        cb(reslist, start, end);\r\n    }));\r\n}"]}